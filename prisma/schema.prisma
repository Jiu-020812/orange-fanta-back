generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RecordType {
  IN
  OUT
  PURCHASE
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  categories Category[]
  items      Item[]
  records    Record[]
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  items Item[]

  @@unique([userId, name])
  @@index([userId, sortOrder])
}

model Item {
  id       Int     @id @default(autoincrement())
  name     String
  size     String
  imageUrl String?

  legacyId String?
  memo     String?
  barcode  String?

  createdAt DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  records Record[]

  @@unique([userId, categoryId, legacyId])
  @@unique([userId, barcode])
  @@index([userId, categoryId])
}

model Record {
  id        Int @id @default(autoincrement())
  type      RecordType
  price     Int?
  count     Int @default(1)
  date      DateTime
  memo      String?

  purchaseId Int?    
  purchase   Record?   @relation("PurchaseToIn", fields: [purchaseId], references: [id], onDelete: SetNull)
  arrivals   Record[]  @relation("PurchaseToIn") 

  userId    Int
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  itemId    Int
  item      Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([userId, itemId, date])
  @@index([purchaseId])
}

