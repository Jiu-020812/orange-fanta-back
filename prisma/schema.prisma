generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RecordType {
  IN
  OUT
  PURCHASE
}

enum Provider {
  NAVER
  COUPANG
  ELEVENST
  KREAM
  ETC
}

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  password      String  
  name          String?
  emailVerified Boolean  @default(false) 
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  categories    Category[]
  items         Item[]
  records       Record[]
  externalSkuMaps ExternalSkuMap[]

  sessions      Session[]         
  verifyTokens  EmailVerifyToken[] 

 passwordResetTokens PasswordResetToken[]
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  items Item[]

  @@unique([userId, name])
  @@index([userId, sortOrder])
}

model Item {
  id       Int     @id @default(autoincrement())
  name     String
  size     String
  imageUrl String?

  sku      String?
  legacyId String?
  memo     String?
  barcode  String?

  createdAt DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  records Record[]
  externalSkuMaps ExternalSkuMap[]

  @@unique([userId, categoryId, legacyId])
  @@unique([userId, barcode])
  @@unique([userId, sku])
  @@index([userId, categoryId])
}

model Record {
  id        Int @id @default(autoincrement())
  type      RecordType
  price     Int?
  count     Int @default(1)
  date      DateTime
  memo      String?

  purchaseId Int?    
  purchase   Record?   @relation("PurchaseToIn", fields: [purchaseId], references: [id], onDelete: SetNull)
  arrivals   Record[]  @relation("PurchaseToIn") 

  userId    Int
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  itemId    Int
  item      Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([userId, itemId, date])
  @@index([purchaseId])
}

model Session {
  id        Int      @id @default(autoincrement())
  userId    Int
  tokenHash String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}


model EmailVerifyToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  tokenHash String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model ExternalSkuMap {
  id          Int      @id @default(autoincrement())
  userId      Int
  provider    Provider
  externalSku String
  itemId      Int
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([userId, provider, externalSku])
  @@index([userId, itemId])
}
