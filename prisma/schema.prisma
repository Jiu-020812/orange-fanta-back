generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RecordType {
  IN
  OUT
  PURCHASE
}

enum Provider {
  NAVER
  COUPANG
  ELEVENST
  ETC
}

enum InventoryMode {
  NORMAL
  EXCLUSIVE
}

enum SyncJobStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
}

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  password      String  
  name          String?
  emailVerified Boolean  @default(false) 
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  categories    Category[]
  items         Item[]
  records       Record[]
  externalSkuMaps ExternalSkuMap[]
  channelListings ChannelListing[]
  inventoryPolicies ItemInventoryPolicy[]
  inventorySyncJobs InventorySyncJob[]
  channelConnections ChannelConnection[]

  sessions      Session[]         
  verifyTokens  EmailVerifyToken[] 

 passwordResetTokens PasswordResetToken[]
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  items Item[]

  @@unique([userId, name])
  @@index([userId, sortOrder])
}

model Item {
  id       Int     @id @default(autoincrement())
  name     String
  size     String
  imageUrl String?

  sku      String?
  legacyId String?
  memo     String?
  barcode  String?

  createdAt DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  records Record[]
  externalSkuMaps ExternalSkuMap[]
  channelListings ChannelListing[]
  inventoryPolicy ItemInventoryPolicy?
  inventorySyncJobs InventorySyncJob[]

  @@unique([userId, categoryId, legacyId])
  @@unique([userId, barcode])
  @@unique([userId, sku])
  @@index([userId, categoryId])
}

model Record {
  id        Int @id @default(autoincrement())
  type      RecordType
  price     Int?
  count     Int @default(1)
  date      DateTime
  memo      String?

  purchaseId Int?    
  purchase   Record?   @relation("PurchaseToIn", fields: [purchaseId], references: [id], onDelete: SetNull)
  arrivals   Record[]  @relation("PurchaseToIn") 

  userId    Int
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  itemId    Int
  item      Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([userId, itemId, date])
  @@index([purchaseId])
}

model Session {
  id        Int      @id @default(autoincrement())
  userId    Int
  tokenHash String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}


model EmailVerifyToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  tokenHash String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model ExternalSkuMap {
  id          Int      @id @default(autoincrement())
  userId      Int
  provider    Provider
  externalSku String
  itemId      Int
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([userId, provider, externalSku])
  @@index([userId, itemId])
}

model ChannelListing {
  id              Int      @id @default(autoincrement())
  userId          Int
  provider        Provider
  itemId          Int
  channelProductId String?
  channelOptionId  String?
  externalSku     String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  inventorySyncJobs InventorySyncJob[]

  @@unique([userId, provider, itemId])
  @@index([userId, provider])
}

model ItemInventoryPolicy {
  id               Int           @id @default(autoincrement())
  userId           Int
  itemId           Int           @unique
  mode             InventoryMode @default(NORMAL)
  buffer           Int           @default(1)
  minVisible       Int           @default(1)
  exclusiveProvider Provider?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([userId, mode])
}

model InventorySyncJob {
  id         Int           @id @default(autoincrement())
  userId     Int
  provider   Provider
  itemId     Int
  listingId  Int?
  targetQty  Int
  status     SyncJobStatus @default(PENDING)
  attempts   Int           @default(0)
  lastError  String?
  nextRunAt  DateTime      @default(now())
  lockedAt   DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  listing ChannelListing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  @@unique([userId, provider, itemId])
  @@index([status, nextRunAt])
  @@index([userId, provider, itemId])
}

model ChannelConnection {
  id         Int      @id @default(autoincrement())
  userId     Int
  provider   Provider
  credentials Json
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId, provider])
}
